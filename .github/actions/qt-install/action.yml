name: Install Qt
description: Install Qt with standard QGroundControl modules
inputs:
  version:
    description: Qt version to install
    required: true
  host:
    description: Host platform (linux, mac, windows, etc.)
    required: true
  target:
    description: Target platform (desktop, android, ios)
    required: false
    default: desktop
  arch:
    description: Architecture (linux_gcc_64, clang_64, win64_msvc2022_64, etc.)
    required: true
  dir:
    description: Installation directory
    required: false
    default: ${{ github.workspace }}/.qt
  modules:
    description: Qt modules to install (use build-config.outputs.qt_modules)
    required: false
    default: ''
  archives:
    description: Optional Qt archives subset to install (space-separated)
    required: false
    default: ''
runs:
  using: composite
  steps:
    - name: Compute Qt cache fingerprint
      id: qt-cache-key
      shell: bash
      env:
        QT_MODULES: ${{ inputs.modules }}
        QT_ARCHIVES: ${{ inputs.archives }}
      run: |
        set -euo pipefail
        cache_input="${QT_MODULES}"$'\n'"${QT_ARCHIVES}"
        if command -v sha256sum >/dev/null 2>&1; then
          digest="$(printf '%s' "$cache_input" | sha256sum | cut -d' ' -f1)"
        else
          digest="$(printf '%s' "$cache_input" | shasum -a 256 | awk '{print $1}')"
        fi
        echo "digest=${digest}" >> "$GITHUB_OUTPUT"

    - name: Restore extracted Qt cache
      uses: actions/cache@v5
      with:
        path: ${{ inputs.dir }}/Qt/${{ inputs.version }}
        key: qt-extracted-${{ runner.os }}-${{ inputs.host }}-${{ inputs.target }}-${{ inputs.arch }}-${{ inputs.version }}-${{ steps.qt-cache-key.outputs.digest }}

    - name: Ensure pip available
      shell: bash
      run: python3 -m ensurepip 2>/dev/null || true
    - name: Install Qt ${{ inputs.version }}
      uses: jurplel/install-qt-action@v4
      with:
        version: ${{ inputs.version }}
        host: ${{ inputs.host }}
        target: ${{ inputs.target }}
        arch: ${{ inputs.arch }}
        dir: ${{ inputs.dir }}
        modules: ${{ inputs.modules }}
        archives: ${{ inputs.archives }}
        setup-python: false
        cache: true
